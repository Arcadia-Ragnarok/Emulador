#####################################################################
#              ____                     _                           #
#             /    |                   | |_                         #
#            /     |_ __ ____  __ _  __| |_  __ _                   #
#           /  /|  | '__/  __|/ _` |/ _  | |/ _` |                  #
#          /  __   | | |  |__| (_| | (_| | | (_| |                  #
#         /  /  |  |_|  \____|\__,_|\__,_|_|\__,_|                  #
#        /__/   |__|  [ Ragnarok Emulator ]                         #
#                                                                   #
#####################################################################
#                  Idealizado por: Spell Master                     #
#####################################################################
# - Este código é livre para editar, redistribuir de acordo com os  #
# termos da GNU General Public License, publicada sobre conselho    #
# pela Free Software Foundation.                                    #
#                                                                   #
# - Qualquer ato de comercialização desse software está previsto    #
# em leis internacionais, junto com este(s) código(s) você recebeu  #
# uma cópia de licença de uso.                                      #
# - Caso não tenha recebido veja: http://www.gnu.org/licenses/      #
#####################################################################

# @configure_input@

@SET_MAKE@

HAVE_MYSQL=@HAVE_MYSQL@
ifeq ($(HAVE_MYSQL),yes)
	ALL_DEPENDS=common_sql login_sql char_sql map_sql tools sysinfo | import
	SQL_DEPENDS=common_sql login_sql char_sql map_sql sysinfo | import
	COMMON_SQL_DEPENDS=mt19937ar libconfig sysinfo
	LOGIN_SQL_DEPENDS=mt19937ar libconfig common_sql sysinfo
	CHAR_SQL_DEPENDS=mt19937ar libconfig common_sql sysinfo
	MAP_SQL_DEPENDS=mt19937ar libconfig common_sql sysinfo
	TOOLS_DEPENDS=mt19937ar libconfig common_sql sysinfo
else
	ALL_DEPENDS=needs_mysql
	SQL_DEPENDS=needs_mysql
	COMMON_SQL_DEPENDS=needs_mysql
	LOGIN_SQL_DEPENDS=needs_mysql
	CHAR_SQL_DEPENDS=needs_mysql
	MAP_SQL_DEPENDS=needs_mysql
	TOOLS_DEPENDS=needs_mysql
endif

HAVE_PERL=@HAVE_PERL@

MF_TARGETS = Makefile $(addsuffix /Makefile, Source/src/common Source/3rdparty/mt19937ar \
             Source/3rdparty/libconfig Source/src/char Source/src/login Source/src/map \
             Source/src/tool Source/src/test)

CC = @CC@
export CC

#####################################################################
.PHONY: sql  \
	common_sql \
	mt19937ar \
	login_sql \
	char_sql \
	map_sql \
	tools \
	import \
	test \
	clean \
	buildclean \
	distclean \
	sysinfo \
	hooks \
	help

all: $(ALL_DEPENDS)

sql: $(SQL_DEPENDS)

$(MF_TARGETS): %: %.in config.status
	@echo "	CONFIGURE"
	@if [ -x config.status ]; then \
		echo "Reconfiguring with options: $$(./config.status --config)"; \
		./config.status; \
	else \
		echo "Unable to find a previous config.status.  ./configure will be re-run with the default options."; \
		echo "If you want to use custom options, please press CTRL-C and run ./configure yourself"; \
		for i in 1 2 3 4 5 6 7 8 9 10; do \
			printf "\a. "; \
			sleep 1; \
		done; \
		echo ""; \
		./configure; \
	fi;

common_sql: $(COMMON_SQL_DEPENDS) Source/src/common/Makefile
	@echo "	MAKE	$@"
	@$(MAKE) -C Source/src/common sql

mt19937ar: Source/3rdparty/mt19937ar/Makefile
	@echo "	MAKE	$@"
	@$(MAKE) -C Source/3rdparty/mt19937ar

libconfig: Source/3rdparty/libconfig/Makefile
	@echo "	MAKE	$@"
	@$(MAKE) -C Source/3rdparty/libconfig

login_sql: $(LOGIN_SQL_DEPENDS) Source/src/login/Makefile
	@echo "	MAKE	$@"
	@$(MAKE) -C Source/src/login sql

char_sql: $(CHAR_SQL_DEPENDS) Source/src/char/Makefile
	@echo "	MAKE	$@"
	@$(MAKE) -C Source/src/char

map_sql: $(MAP_SQL_DEPENDS) Source/src/map/Makefile
	@echo "	MAKE	$@"
	@$(MAKE) -C Source/src/map sql

tools: $(TOOLS_DEPENDS) Source/src/tool/Makefile
	@echo "	MAKE	$@"
	@$(MAKE) -C Source/src/tool

test: Source/src/test/Makefile
	@echo "	MAKE	$@"
	@$(MAKE) -C Source/src/test

import: Makefile
	@# 1) create Config/import folder
	@# 2) add missing files
	@echo "building Config/import folder..."
	@if test ! -d Config/import ; then mkdir Config/import ; fi
	@for f in $$(ls Config/import-tmpl) ; do if test ! -e Config/import/$$f ; then cp Config/import-tmpl/$$f Config/import ; fi ; done

clean buildclean: $(MF_TARGETS)
	@$(MAKE) -C Source/src/common $@
	@$(MAKE) -C Source/3rdparty/mt19937ar $@
	@$(MAKE) -C Source/3rdparty/libconfig $@
	@$(MAKE) -C Source/src/login $@
	@$(MAKE) -C Source/src/char $@
	@$(MAKE) -C Source/src/map $@
	@$(MAKE) -C Source/src/tool $@
	@$(MAKE) -C Source/src/test $@

distclean: clean
	@-rm -f $(MF_TARGETS) config.status config.log

sysinfo: config.status
	@./sysinfogen.sh Source/src/common/sysinfo_new.inc @CFLAGS@ @CPPFLAGS@
	@if cmp -s Source/src/common/sysinfo.inc Source/src/common/sysinfo_new.inc; then \
		rm Source/src/common/sysinfo_new.inc ; \
	else \
		mv Source/src/common/sysinfo_new.inc Source/src/common/sysinfo.inc ; \
	fi

config.status: configure
	@echo "	RECONFIGURE"
	@./config.status --recheck && ./config.status

help: Makefile
	@echo "possible targets are:"
	@echo "'common_sql'  - builds object files used in SQL servers"
	@echo "'mt19937ar'   - builds object file of Mersenne Twister MT19937"
	@echo "'libconfig'   - builds object files of libconfig"
	@echo "'login_sql'   - builds login server"
	@echo "'char_sql'    - builds char server"
	@echo "'map_sql'     - builds map server"
	@echo "'tools'       - builds all the tools in Source/src/tools"
	@echo "'import'      - builds Config/import folder from the template Config/import-tmpl"
	@echo "'all'         - builds all the above targets"
	@echo "'sql'         - builds sql servers (targets 'common_sql' 'login_sql' 'char_sql'"
	@echo "                'map_sql' and 'import')"
	@echo "'test'        - builds tests"
	@echo "'clean'       - cleans executables and objects"
	@echo "'buildclean'  - cleans build temporary (object) files, without deleting the"
	@echo "                executables"
	@echo "'distclean'   - cleans files generated by ./configure"
	@echo "'sysinfo'     - re-generates the System Info include"
ifeq ($(HAVE_PERL),yes)
	@echo "'hooks'       - re-generates the definitions for the HPM"
endif
	@echo "'help'        - outputs this message"

#####################################################################

needs_mysql:
	@echo "MySQL not found or disabled by the configure script"
	@exit 1
